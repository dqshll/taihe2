<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>欢乐找茬</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        
    </style>
</head>

<body>

    <div class="container" id="view_play">
        <img src="asset/bg.jpg" class="img_bg"/>
        <div id="pic_area">
            <img id="pic" src="https://miniapp.edisonx.cn/data/files/cha/pics/11.jpg">
        </div>
        <div class="sec">
            <img id="btn_tujian" src="asset/btn_tj_0.png">
        </div>
        <h3 id="desc">测试下你的眼力! 查看上图与大屏幕不同之处, 赢取丰厚奖品!</h3>
    </div>

    <div class="popup" id="view_tujian">
        <div class="opacity_cover"></div>

        <div id="dialog">
            <div id="list">
                <div id='raw_0' class='tj_item'>
                    <div class="icon_wrap icon_first">
                        <img id='icon_0_0' src='asset/tj_0_0_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_1' src='asset/tj_0_1_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_2' src='asset/tj_0_2_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_3' src='asset/tj_0_2_0.png' class='tj_icon'>
                    </div>
                    <div class="btn_wrap">
                        <img id='btn_charge_0' src='asset/charge_0.png' class='brn_charge'>
                    </div>
                </div>

                <div id='raw_1' class='tj_item'>
                    <div class="icon_wrap icon_first">
                        <img id='icon_1_0' src='asset/tj_1_0_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_1_1' src='asset/tj_1_1_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_1_2' src='asset/tj_1_2_0.png' class='tj_icon'>
                    </div>
                    <div class="btn_wrap">
                        <img id='btn_charge_1' src='asset/charge_0.png' class='brn_charge'>
                    </div>
                </div>

                <h4 id="readme">温馨提示:<br>
                        寻找与大屏幕海报不同点。每找到一处可获得一枚勋章，集齐后可兑换奖品。<br>每次游戏结果可累加哦！多玩多得, 大家一起来比眼力吧！</h5>
            </div>
        </div>
    </div>
   
</body>
<script src="js/jquery.js"></script>
<script src="js/jweixin-1.2.0.js"></script>
<!-- <script type="text/javascript" src="js/zoom.js"> </script> -->
<script src='js/vconsole.min.js'></script>
<script>
var JudgeRadiusSquare = 100;
var MainUrl = 'https://miniapp.edisonx.cn/h5/taihe2/php/cha_info.php';
var IndWidth = 40;

var ChaInfoList = [];
var CurChaId = null;

$(document).ready(function(){
    requestChaPicInfo('7801');
});

function requestChaPicInfo (chaPicId) {
        $.ajax({
            url: MainUrl,
            type: "get",
            jsonType: "json",
            timeout: 10000,
            data: {
                action:'query', 
            },
            success: function (data) {
                console.log('200ok');

                var jsonObj = JSON.parse(data);

                if (jsonObj['error'] == 0) {
                    for(var id in jsonObj['list']){
                        var value = jsonObj['list'];
                        value = value[id];
                        var chaInfo = [];
                        var pos_list = value['pos'].split(';');
                        var pic_url = value['url'];
                        chaInfo ['width'] = value['w'];
                        chaInfo ['height'] = value['h'];

                        $('#pic').attr('src', pic_url);

                        pos_list.forEach(function(value,i){
                        　　var tmp = value.split(',')
                            chaInfo.push({
                                "x":tmp[0],
                                "y":tmp[1],
                                "r":tmp[2]
                            })
                        });
                        var picture = document.getElementById('pic');
                        picture.addEventListener('touchstart', onPickingUp);
                        // picture.onmousedown =  onPickingUp;
        
                        ChaInfoList[id] = chaInfo;
                        CurChaId = id;
                    };
                } else {
                    console.log(jsonObj['msg']);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log('error');
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
            },
            complete: function (XMLHttpRequest, status) {
                console.log('complete: ' + status);

                if (status == 'timeout') {
                    console.log("超时");
                }
            }
        });
    }
    
    function onPickingUp(event) {
        console.log('onPickingUp')
    　　 
    　　 var pickPos;

        outputObj(event);

        if ("targetTouches" in event) {
            console.log('targetTouches');
            var touch = event.targetTouches[0]; 
            pickPos = {
                x:touch.pageX,
                y:touch.pageY
            };
        } else if("x" in event) {
            pickPos = {
                x:event.x,
                y:event.y
            };
        } else {
            return;
        }
       
        console.log('pick ' + pickPos.x + ',' + pickPos.y);

        var oImgBox = document.createElement("img");
        oImgBox.setAttribute("style", "width:" + IndWidth + "px;height:auto;position:fixed;left:" + (pickPos.x - IndWidth*0.5) + "px;top:" + (pickPos.y - IndWidth*0.5) + "px;");
        var imgPic = document.getElementById('pic');
        insertAfter(oImgBox, imgPic);

        if(checkHit(pickPos) || false) {
            oImgBox.setAttribute("id", "correct");
            oImgBox.setAttribute("src", "asset/diff_match.png");
        } else {
            oImgBox.setAttribute("id", "wrong");
            oImgBox.setAttribute("src", "asset/diff_miss.png");

            window.setTimeout(function(){
                console.log('removing');
                oImgBox.remove();
            }, 1000);
        }

        return true;
    }

    function checkHit (pos) {
        console.log("checking touch x=" + pos.x + ' y=' + pos.y);  
        var chaInfo = ChaInfoList[CurChaId];
        var scale = 1;
        if(chaInfo.hasOwnProperty('scale')) {
            scale = chaInfo['scale'];
        } else {
            var pxWidth = $('#pic').outerWidth(true);
            var pxHeight = $('#pic').outerHeight(true);
            
            scale = pxWidth / chaInfo['width'];
            chaInfo['scale'] = scale;
            console.log('Calculating w=' + pxWidth + " ,h=" + pxHeight + ' ,s=' + scale);
        }

        console.log('checkHit s=' + scale);
        
        for(var i=0; i<chaInfo.length; i++) {
            var x = chaInfo[i].x * scale;
            var y = chaInfo[i].y * scale;
            var r = chaInfo[i].r * scale;

            var sum = (pos.x - x) * (pos.x - x) + (pos.y - y) * (pos.y - y);
            var r2 = r*r;
            console.log ('comparing x=' + x + ' y=' + y + ' r=' + r);
            if (sum < r2) {
                return true;
            }
        }
        return false;
    }

    function insertAfter(newEle, targetEle){
        var parentEle = targetEle.parentNode;
        if(parentEle.lastChild == targetEle){
            parentEle.appendChild(newEle);
        }
        else{
            parentEle.insertBefore(newEle, targetEle.nextSibling);
        }
    }

    function outputObj(obj) {
        var description = "";
        for (var i in obj) {
            description += i + " = " + obj[i] + "\n";
        }
        console.log(description);
    }

</script>
</html>