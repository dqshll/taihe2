<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>欢乐找茬</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        
    </style>
</head>

<body>

    <div class="container" id="view_play">
        <img src="asset/bg.jpg" class="img_bg"/>
        <div id="pic_area">
            <img id="pic" alt="玩命加载中...">
        </div>
        <div class="sec">
            <img id="btn_tujian" src="asset/btn_tj_0.png">
        </div>
        <h3 id="desc">测试下你的眼力! 查看上图与大屏幕不同之处, 赢取丰厚奖品!</h3>
    </div>

    <div class="popup" id="view_tujian">
        <div class="opacity_cover"></div>

        <div id="dialog">
            <div id="list">
                <div id='raw_0' class='tj_item'>
                    <div class="icon_wrap icon_first">
                        <img id='icon_0_0' src='asset/tj_0_0_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_1' src='asset/tj_0_1_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_2' src='asset/tj_0_2_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_3' src='asset/tj_0_2_0.png' class='tj_icon'>
                    </div>
                    <div class="btn_wrap">
                        <img id='btn_charge_0' src='asset/charge_0.png' class='brn_charge'>
                    </div>
                </div>

                <div id='raw_1' class='tj_item'>
                    <div class="icon_wrap icon_first">
                        <img id='icon_1_0' src='asset/tj_1_0_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_1_1' src='asset/tj_1_1_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_1_2' src='asset/tj_1_2_0.png' class='tj_icon'>
                    </div>
                    <div class="btn_wrap">
                        <img id='btn_charge_1' src='asset/charge_0.png' class='brn_charge'>
                    </div>
                </div>

                <h4 id="readme">温馨提示:<br>
                        寻找与大屏幕海报不同点。每找到一处可获得一枚勋章，集齐后可兑换奖品。<br>每次游戏结果可累加哦！多玩多得, 大家一起来比眼力吧！</h5>
            </div>
        </div>
    </div>
   
</body>
<script src="js/jquery.js"></script>
<script src="js/jweixin-1.2.0.js"></script>
<!-- <script type="text/javascript" src="js/zoom.js"> </script> -->
<script src='js/vconsole.min.js'></script>
<script>
var JudgeRadiusSquare = 100;
var MainUrl = 'https://miniapp.edisonx.cn/h5/taihe2/php/cha_info.php';

var ChaPosList = []

$(document).ready(function(){
    requestChaPicInfo('7801');
});

function requestChaPicInfo (chaPicId) {
        $.ajax({
            url: MainUrl,
            type: "get",
            jsonType: "json",
            timeout: 10000,
            data: {
                action:'cha_info', 
                cid: chaPicId
            },
            success: function (data) {
                console.log('success ' + data);
                var jsonObj = JSON.parse(data);

                if (jsonObj['error'] == 0) {
                    var pos_list = jsonObj['info']['pos'];
                    var pic_url = jsonObj['info']['url'];
                    console.log('pos:' + pos_list + ' url:' + pic_url);

                    $('#pic').attr('src', pic_url);

                    pos_list.forEach(function(value,i){
                    　　var tmp = value.split(',')
                        ChaPosList.push({
                            "x":tmp[0],
                            "y":tmp[0]
                        })
                    });
                    var picture = document.getElementById('pic');
                    picture.addEventListener('touchstart', onPickingUp); 
                } else {
                    console.log(jsonObj['msg']);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log('error');
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
            },
            complete: function (XMLHttpRequest, status) {
                console.log('complete: ' + status);

                if (status == 'timeout') {
                    console.log("超时");
                }
            }
        });
    }
    
    function onPickingUp(event){
        console.log('onTouchStart')
    　　 var touch = event.targetTouches[0]; 
        　　var pickPos = {
            x:touch.pageX,
            y:touch.pageY
        };

        console.log('pick ' + pickPos.x + ',' + pickPos.y);

        var oImgBox = document.createElement("img");
        oImgBox.setAttribute("style", "width:10vw;height:auto;position:fixed;left:" + pickPos.x + "px;top:" + pickPos.y + "px;");
        var imgPic = document.getElementById('pic');
        insertAfter(oImgBox, imgPic);

        if(checkHit(pickPos) || false) {
            oImgBox.setAttribute("id", "correct");
            oImgBox.setAttribute("src", "asset/diff_match.png");
        } else {
            oImgBox.setAttribute("id", "wrong");
            oImgBox.setAttribute("src", "asset/diff_miss.png");

            window.setTimeout(function(){
                console.log('removing');
                oImgBox.remove();
            }, 1000);
        }

        return false;
    }

    function checkHit (pos) {
        for(var i=0; i<pos.length; i++) {
            if ((pos.x - ChaPosList[i].x) * (pos.x - ChaPosList[i].x) + (pos.y - ChaPosList[i].y) * (pos.y - ChaPosList[i].y) < JudgeRadiusSquare) {
                return true;
            }
        }
        return false;
    }

    function insertAfter(newEle, targetEle){
        var parentEle = targetEle.parentNode;
        if(parentEle.lastChild == targetEle){
            parentEle.appendChild(newEle);
        }
        else{
            parentEle.insertBefore(newEle, targetEle.nextSibling);
        }
    }

</script>
</html>