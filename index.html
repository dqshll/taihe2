<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>欢乐找茬</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        
    </style>
</head>

<body>

    <div class="container" id="view_play">
        <img src="asset/bg.jpg" class="img_bg"/>
        <div id="pic_area">
            <img id="pic">
        </div>
        <div class="sec">
            <img id="btn_tujian" src="asset/btn_tj_0.png">
        </div>
        <h3 id="desc">测试下你的眼力! 查看上图与大屏幕不同之处, 赢取丰厚奖品!</h3>
    </div>

    <div class="container" id="view_wait">
        <img src="asset/bg.jpg" class="img_bg"/>
        <section id="wait_count_down">
            <img id="wait_count_down_d1" class="wait_count_down_digit" src="" alt=""></img>
            <img id="wait_count_down_d0" class="wait_count_down_digit" src="" alt=""></img>
        </section>
    </div>

    <div class="popup" id="view_tujian">
        <div class="opacity_cover"></div>

        <div id="dialog">
            <div id="list">
                <div id='raw_0' class='tj_item'>
                    <div class="icon_wrap icon_first">
                        <img id='icon_0_0' src='asset/tj_0_0_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_1' src='asset/tj_0_1_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_2' src='asset/tj_0_2_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_0_3' src='asset/tj_0_2_0.png' class='tj_icon'>
                    </div>
                    <div class="btn_wrap">
                        <img id='btn_charge_0' src='asset/charge_0.png' class='brn_charge'>
                    </div>
                </div>

                <div id='raw_1' class='tj_item'>
                    <div class="icon_wrap icon_first">
                        <img id='icon_1_0' src='asset/tj_1_0_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_1_1' src='asset/tj_1_1_0.png' class='tj_icon'>
                    </div>
                    <div class="icon_wrap">
                        <img id='icon_1_2' src='asset/tj_1_2_0.png' class='tj_icon'>
                    </div>
                    <div class="btn_wrap">
                        <img id='btn_charge_1' src='asset/charge_0.png' class='brn_charge'>
                    </div>
                </div>

                <h4 id="readme">温馨提示:<br>
                        寻找与大屏幕海报不同点。每找到一处可获得一枚勋章，集齐后可兑换奖品。<br>每次游戏结果可累加哦！多玩多得, 大家一起来比眼力吧！</h4>
            </div>
        </div>
    </div>
   
</body>
<script src="js/jquery.js"></script>
<script src="js/jweixin-1.2.0.js"></script>
<!-- <script type="text/javascript" src="js/zoom.js"> </script> -->
<script src='js/vconsole.min.js'></script>
<script>
var JudgeRadiusSquare = 100;
var MainUrl = 'https://miniapp.edisonx.cn/h5/taihe2/php/cha_info.php';
var IndWidth = 40;

var StageList = [];
var CurStageId = null;
var StartTime = 0;
var WaitTimer = null;
var WaitCountDown = 0;

$(document).ready(function(){
    StartTime = getQueryString('t') * 1000;
    CurStageId = getQueryString('cid');
    console.log('starting at ' + StartTime + ' cid=' + CurStageId);
    requestChaPicInfo();
});

function requestChaPicInfo () {
        $.ajax({
            url: MainUrl,
            type: "get",
            jsonType: "json",
            timeout: 10000,
            data: {
                action:'query', 
            },
            success: function (data) {
                console.log('200ok');

                var jsonObj = JSON.parse(data);

                if (jsonObj['error'] == 0) {
                    searchCurAction(jsonObj['actions']);
                } else {
                    console.log(jsonObj['msg']);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log('error');
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
            },
            complete: function (XMLHttpRequest, status) {
                console.log('complete: ' + status);

                if (status == 'timeout') {
                    console.log("超时");
                }
            }
        });
    }

    function searchCurAction (actions) {
        for(var aid in actions){
            if (parseStageList(actions[aid])) {
                toPlayState();
                break;
            }
        }

        outputObj(StageList);
    }

    function parseStageList (jsonList) {
        var foundCurId = false;
        for(var stage in jsonList){
            if (stage.sid == CurStageId) {
                foundCurId = true;
            }

            if (!foundCurId) {
                continue; // skip
            }

            var value = jsonList[sid];
            var chaInfo = [];
            var pos_list = value['pos'].split(';');
           
            chaInfo ['width'] = value['w'];
            chaInfo ['height'] = value['h'];
            chaInfo ['url'] = value['url'];

            pos_list.forEach(function(value,i){
            　　var tmp = value.split(',')
                chaInfo.push({
                    "x":tmp[0],
                    "y":tmp[1],
                    "r":tmp[2]
                })
            });
            var picture = document.getElementById('pic');
            picture.addEventListener('touchstart', onPickingUp);
            // picture.onmousedown =  onPickingUp;

            StageList.push(chaInfo);
        }

        return foundCurId;
    }
    
    function toPlayState () {
        console.log('toPlayState ' + CurStageId);
        for (var stage in StageList) {
            if (stage ['sid'] == CurStageId) {
                $('#pic').attr('src', stage['url']);

                var duration = stage['dur'];
                duration -= StartTime;

                if (duration > 1000) {
                    setTimeout(function(follow_duration){
                        toWaitState(follow_duration);
                    }, duration, stage['fdur']);
                } else {
                    toWaitState(stage['fdur'] + (1000 - duration));
                }

                return;
            } else {
                continue;
            }
        }
        alert('活动未开始, 敬请期待!');
    }

    function getNextStageId () {
        for (var i=0; i< StageList.length; i ++) {
            var stage = StageList[i];
            if (stage ['sid'] == CurStageId) {
                if (i+1 < StageList.length) {
                    return StageList[i+1];
                } else {
                    return null;
                }
            } 
        }
        return null;
    }

    function toWaitState (dur) {
        WaitCountDown = parseInt(dur * 0.001);
        console.log('toWaitState countDown=' + WaitCountDown);

        if (WaitTimer != null) {
            clearInterval(WaitTimer);
        }

        WaitTimer = setInterval(function () {
            updateTimeCounting(-- WaitCountDown);
            if (WaitCountDown <= 0) {
                CurStageId = getNextStageId();
                toPlayState();
            }
        }, 1000);
    }

    function updateTimeCounting (evt) {
        var d0 = evt % 10;
        var d1 = (evt - d0) / 10;
            
        if(evt < 10) {
            $('#wait_count_down_d1').hide();
        } else {
            $('#wait_count_down_d1').show();
            $('#wait_count_down_d1').attr("src", "img/" + d1 + ".png");
        }
        $('#wait_count_down_d0').attr("src", "img/" + d0 + ".png");
    }

    function onPickingUp(event) {
        console.log('onPickingUp')
    　　 
    　　 var pickPos;

        if ("targetTouches" in event) {
            console.log('targetTouches');
            var touch = event.targetTouches[0]; 
            pickPos = {
                x:touch.pageX,
                y:touch.pageY
            };
        } else if("x" in event) {
            pickPos = {
                x:event.x,
                y:event.y
            };
        } else {
            // return;
        }

        var oImgBox = document.createElement("img");
        oImgBox.setAttribute("style", "width:" + IndWidth + "px;height:auto;position:fixed;left:" + (pickPos.x - IndWidth*0.5) + "px;top:" + (pickPos.y - IndWidth*0.5) + "px;");
        var imgPic = document.getElementById('pic');
        insertAfter(oImgBox, imgPic);

        if(checkHit(pickPos) || false) {
            oImgBox.setAttribute("id", "correct");
            oImgBox.setAttribute("src", "asset/diff_match.png");
        } else {
            oImgBox.setAttribute("id", "wrong");
            oImgBox.setAttribute("src", "asset/diff_miss.png");

            window.setTimeout(function(){
                console.log('removing');
                oImgBox.remove();
            }, 1000);
        }

        return true;
    }

    function checkHit (pos) {
        // console.log("checking touch x=" + pos.x + ' y=' + pos.y);  
        var chaInfo = StageList[CurStageId];
        var scale = 1;
        
        var bounding = $('#pic')[0].getBoundingClientRect();

        if(chaInfo.hasOwnProperty('scale')) {
            scale = chaInfo['scale'];
        } else {    
            scale = bounding.width / chaInfo['width'];
            chaInfo['scale'] = scale;
            // console.log('Calculating w=' + bounding.width + " ,h=" + bounding.height + ' ,s=' + scale);
        }

        // console.log('checkHit s=' + scale);
        
        for(var i=0; i<chaInfo.length; i++) {
            var x = chaInfo[i].x * scale + bounding.left;
            var y = chaInfo[i].y * scale + bounding.top;
            var r = chaInfo[i].r * scale;

            var sum = (pos.x - x) * (pos.x - x) + (pos.y - y) * (pos.y - y);
            var r2 = r*r;
            // console.log ('comparing x=' + x + ' y=' + y + ' r=' + r);
            if (sum < r2) {
                return true;
            }
        }
        return false;
    }

    function insertAfter(newEle, targetEle){
        var parentEle = targetEle.parentNode;
        if(parentEle.lastChild == targetEle){
            parentEle.appendChild(newEle);
        }
        else{
            parentEle.insertBefore(newEle, targetEle.nextSibling);
        }
    }

    function outputObj(obj) {
        var description = "";
        for (var i in obj) {
            description += i + " = " + obj[i] + "\n";
        }
        console.log(description);
    }

    function getQueryString(name) {
        var url = window.location.search.substr(0);
        var theRequest = new Object();
        var n = url.indexOf("?")
        if (n != -1) {
            var str = url.substr(n + 1);
            var strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest[name];
    }
</script>
</html>